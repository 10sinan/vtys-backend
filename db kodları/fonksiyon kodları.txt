--kulanıcnı kaydı ekeleme
CREATE OR REPLACE FUNCTION register_user(
    p_first_name text,
    p_last_name text,
    p_username text,
    p_email text,
    p_password text, -- hashlenmiş şifre
    p_role_id uuid,  -- system_roles id
    p_birthday date DEFAULT NULL, 
    p_profile_pic_id uuid DEFAULT NULL 
)
RETURNS uuid AS $$
DECLARE
    new_user_id uuid;
BEGIN
    -- rastgele id ata
    new_user_id := gen_random_uuid(); 

    --users a veriyi kaydet
    INSERT INTO users (
        id, 
        first_name, 
        last_name, 
        username, 
        email, 
        password, 
        role_id, 
        birthday,
        profile_pic_id
    )
    VALUES (
        new_user_id, 
        p_first_name, 
        p_last_name, 
        p_username, 
        p_email, 
        p_password, 
        p_role_id, 
        p_birthday,
        p_profile_pic_id
    );

    -- kullanıcı id geri don
    RETURN new_user_id;
$$ LANGUAGE plpgsql;


--trigger için gunceleme fonkdıyonu
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    -- Yeni verinin updated_at sütununa şu anki zamanı yaz
    NEW.updated_at = now();
    RETURN NEW;
END;
$$ language 'plpgsql';


--story ekleme
CREATE OR REPLACE FUNCTION create_story_content(
p_creator_id uuid,          	
    p_title text,               
    p_price float,   
    p_text text,                
    p_media_id uuid DEFAULT NULL
)
RETURNS uuid AS $$
DECLARE
    v_content_id uuid; -- Yeni oluşturulacak içerik ID'sini tutacak değişken
BEGIN
	--rastgele id üret
    v_content_id := gen_random_uuid();

    -- genel bilgileri kaydet
    INSERT INTO contents (id, content_creator_id, title, price)
    VALUES (v_content_id, p_creator_id, p_title, p_price);

    -- story_contents tablosuna metni kaydet
    INSERT INTO story_contents (id, content_id, text, media_id)
    VALUES (gen_random_uuid(), v_content_id, p_text, p_media_id);

    -- oluşan ID'yi geri döndür 
    RETURN v_content_id;
END;
$$ LANGUAGE plpgsql;


--ornek çağırma
SELECT create_story_content(
    '11111111-2222-3333-4444-555555555555', -- gerçek bir content_creator_id 
    'Sihirli Orman',                        -- başlık
    15.99,                                  -- fiyat
    'Bir zamanlar uzak bir ormanda...'      -- hikaye Metni
);


--içeriğin ortalama puanını getir
CREATE OR REPLACE FUNCTION get_content_score(p_content_id uuid)
RETURNS numeric AS $$
DECLARE
    avg_score numeric;
BEGIN
    SELECT ROUND(AVG(rating)::numeric, 1) 
    INTO avg_score
    FROM ratings
    WHERE content_id = p_content_id;
    
    -- Eğer hiç oy yoksa 0 döndür, varsa ortalamayı döndür
    RETURN COALESCE(avg_score, 0);
END;
$$ LANGUAGE plpgsql;


--kendine oy verememesi kullanıcının
CREATE OR REPLACE FUNCTION prevent_self_rating()
RETURNS TRIGGER AS $$
DECLARE
    v_creator_user_id uuid;
BEGIN
    --  yazarın user_id'sini bul
    SELECT cc.user_id INTO v_creator_user_id
    FROM contents c
    JOIN content_creators cc ON c.content_creator_id = cc.id
    WHERE c.id = NEW.content_id;

    -- Eğer oy veren kişi (NEW.user_id) ile yazar aynıysa hata ver
    IF NEW.user_id = v_creator_user_id THEN
        RAISE EXCEPTION 'Yazarlar kendi içeriklerini oylayamazlar!';
    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- üsttekinin trigger ı
CREATE TRIGGER check_self_rating
BEFORE INSERT OR UPDATE ON ratings
FOR EACH ROW
EXECUTE PROCEDURE prevent_self_rating();


-- okuma süresi hesaplama
CREATE OR REPLACE FUNCTION calculate_reading_time(p_content_id uuid)
RETURNS text AS $$
DECLARE
    v_word_count integer;
    v_minutes integer;
BEGIN
    -- 1. Hikaye metnini bul ve kelime sayısını (kabaca) hesapla
    -- array_length(regexp_split_to_array(text, '\s+'), 1) boşluklara göre ayırıp sayar
    SELECT array_length(regexp_split_to_array(text, '\s+'), 1)
    INTO v_word_count
    FROM story_contents
    WHERE content_id = p_content_id;

    -- boşsa null dön
    IF v_word_count IS NULL THEN
        RETURN 'Belirsiz'; -- Veya resimse 'Görsel' diyebilirsin
    END IF;

    -- 2. Dakikayı hesapla (En az 1 dk olsun) buralar gpt
    v_minutes := CEIL(v_word_count / 200.0);

    RETURN v_minutes || ' dk okuma';
END;
$$ LANGUAGE plpgsql;









